<script>
const WORKER_URL = "https://jojo-ai-worker.cfrvwj2pyg.workers.dev";

const chat = document.getElementById('chat');
const input = document.getElementById('input');
const send = document.getElementById('send');
const personaSel = document.getElementById('persona');
const statusEl = document.getElementById('status');
const persist = document.getElementById('persist');
const KEY = "jojo_ai_chat_history_v1";

function bubble(text, me=false) {
  const div = document.createElement('div');
  div.className = 'msg ' + (me ? 'me' : 'bot');
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function loadHistory() {
  try {
    const saved = localStorage.getItem(KEY);
    if (!saved) return;
    const arr = JSON.parse(saved);
    arr.forEach(m => bubble(m.text, m.me));
  } catch {}
}

function saveHistory() {
  if (!persist.checked) return;
  try {
    const nodes = Array.from(document.querySelectorAll('.msg')).map(n => ({
      text: n.textContent,
      me: n.classList.contains('me')
    }));
    localStorage.setItem(KEY, JSON.stringify(nodes.slice(-40)));
  } catch {}
}

function clearHistory() {
  localStorage.removeItem(KEY);
  chat.innerHTML = "";
}

async function ask() {
  const text = input.value.trim();
  if (!text) return;
  bubble(text, true);
  input.value = "";
  saveHistory();

  statusEl.textContent = "送信中…";
  try {
    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        message: text,
        persona: personaSel.value
      })
    });
    const data = await res.json();
    const reply = data.reply || data.error || "（エラー）";
    bubble(reply, false);
  } catch (e) {
    bubble("エラー: " + e.message, false);
  } finally {
    statusEl.textContent = "準備OK";
    saveHistory();
  }
}

send.addEventListener('click', ask);
input.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') ask();
});

loadHistory();
statusEl.textContent = "準備OK";
</script>